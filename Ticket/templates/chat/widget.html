<div id="chat-widget" class="position-fixed bottom-0 end-0 m-4" style="z-index: 1000;">
    <button id="chat-button" class="btn btn-primary-custom rounded-circle p-3 shadow">
        <i class="bi bi-chat-dots-fill fs-4"></i>
    </button>

    <div id="chat-window" class="card shadow d-none" style="width: 300px; height: 400px;">
        <div class="card-header bg-primary-custom text-white d-flex justify-content-between align-items-center">
            <span>Support Chat</span>
            <button id="chat-close" class="btn-close btn-close-white small"></button>
        </div>
        <div class="card-body overflow-auto" id="chat-messages" style="height: 300px;">
            <!-- Messages will be loaded here -->
        </div>
        <div class="card-footer p-2">
            <div class="input-group">
                <input type="text" id="chat-input" class="form-control" placeholder="Type a message...">
                <button id="chat-send" class="btn btn-primary-custom">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chatButton = document.getElementById('chat-button');
        const chatWindow = document.getElementById('chat-window');
        const chatClose = document.getElementById('chat-close');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        const chatMessages = document.getElementById('chat-messages');

        let chatOpen = false;

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function appendMessage(text, isUser, time) {
            const div = document.createElement('div');
            div.className = `d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'} mb-2`;
            div.innerHTML = `
                <div class="card p-2 ${isUser ? 'bg-primary-custom text-white' : 'bg-light'} ">
                    <small class="d-block text-white-50 text-end" style="font-size: 0.7em;">${time || ''}</small>
                    ${text}
                </div>
            `;
            chatMessages.appendChild(div);
            scrollToBottom();
        }

        async function fetchMessages() {
            try {
                const response = await fetch('/chat/api/get/');
                const data = await response.json();
                chatMessages.innerHTML = '';
                data.messages.forEach(msg => {
                    appendMessage(msg.message, !msg.is_admin_reply, msg.timestamp);
                });
            } catch (error) {
                console.error('Error fetching messages:', error);
            }
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            // Optimistic UI
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            appendMessage(text, true, time);
            chatInput.value = '';

            try {
                const response = await fetch('/chat/api/send/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ message: text })
                });

                if (!response.ok) {
                    console.error('Failed to send message');
                    // Handle error (maybe remove optimistic message or show error)
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        chatButton.addEventListener('click', () => {
            chatWindow.classList.toggle('d-none');
            chatOpen = !chatWindow.classList.contains('d-none');
            if (chatOpen) {
                fetchMessages();
            }
        });

        chatClose.addEventListener('click', () => {
            chatWindow.classList.add('d-none');
            chatOpen = false;
        });

        chatSend.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Poll for new messages every 10 seconds if open
        setInterval(() => {
            if (chatOpen) fetchMessages();
        }, 10000);
    });
</script>